{# templates/home/index.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}Home{% endblock %}

{% block body %}
<div class="container py-4">
  {% set tz = app.user ? app.user.timezone : 'Europe/Paris' %}

  {# --- ADMIN VIEW --- #}
  {% if is_granted('ROLE_ADMIN') %}
    {# BOX 1: Accepted = To do #}
    <div class="card bg-dark border-secondary rounded-2 mb-3">
      <div class="card-header border-secondary d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Orders to do (accepted)</span>
        <span class="badge text-bg-secondary rounded-1">
          {{ acceptedOrders|length }}
        </span>
      </div>

      <div class="card-body p-0">
        {% if acceptedOrders is empty %}
          <p class="text-secondary small m-3 mb-2">
            No accepted orders for now.
          </p>
        {% else %}
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0 home-table">
              <thead class="small text-secondary">
                <tr>
                  <th>Title</th>
                  <th>Client</th>
                  <th>Brief</th>
                  <th>Due</th>
                </tr>
              </thead>
              <tbody>
              {% for order in acceptedOrders %}
                <tr role="button"
                    onclick="window.location='{{ path('app_order_show', { id: order.id }) }}'">
                  <td class="fw-medium" data-label="Title">
                    {{ order.title }}
                  </td>
                  <td class="text-secondary" data-label="Client">
                    {{ order.client ? order.client.name : '—' }}
                  </td>
                  <td class="text-secondary small" data-label="Brief">
                    {% set brief = order.brief ?? '' %}
                    {% if brief|length > 120 %}
                      {{ brief|slice(0, 120) ~ '…' }}
                    {% else %}
                      {{ brief }}
                    {% endif %}
                  </td>
                  <td class="text-secondary" data-label="Due">
                    {{ order.dueAt ? order.dueAt|date('Y-m-d H:i', tz) : '—' }}
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </div>

    {# BOX 2: Created = need review #}
    <div class="card bg-dark border-secondary rounded-2">
      <div class="card-header border-secondary d-flex justify-content-between align-items-center">
        <span class="fw-semibold">New orders to review</span>
        <span class="badge text-bg-secondary rounded-1">
          {{ createdOrders|length }}
        </span>
      </div>

      <div class="card-body p-0">
        {% if createdOrders is empty %}
          <p class="text-secondary small m-3 mb-2">
            No orders waiting for review.
          </p>
        {% else %}
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0 home-table">
              <thead class="small text-secondary">
                <tr>
                  <th>Title</th>
                  <th>Client</th>
                  <th>Due</th>
                  <th class="text-end">Price</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
              {% for order in createdOrders %}
                <tr role="button"
                    onclick="window.location='{{ path('app_order_show', { id: order.id }) }}'">
                  <td class="fw-medium" data-label="Title">
                    {{ order.title }}
                  </td>
                  <td class="text-secondary" data-label="Client">
                    {{ order.client ? order.client.name : '—' }}
                  </td>
                  <td class="text-secondary" data-label="Due">
                    {{ order.dueAt ? order.dueAt|date('Y-m-d H:i', tz) : '—' }}
                  </td>
                  <td class="text-end" data-label="Price">
                    {{ (order.price / 100)|number_format(2, ',', ' ') }} €
                  </td>
                  <td class="text-end" data-label="Actions">
                    <div class="d-inline-flex gap-1">
                      <form method="post"
                            action="{{ path('app_order_accept', { id: order.id }) }}"
                            onsubmit="event.stopPropagation();">
                        <input type="hidden" name="back" value="{{ path('app_home') }}">
                        <input type="hidden" name="_token"
                               value="{{ csrf_token('wf-accept' ~ order.id) }}">
                        <button class="btn btn-sm btn-primary rounded-1"
                                type="submit"
                                onclick="event.stopPropagation();">
                          Accept
                        </button>
                      </form>

                      <form method="post"
                            action="{{ path('app_order_refuse', { id: order.id }) }}"
                            onsubmit="event.stopPropagation(); return confirm('Refuse this order?');">
                        <input type="hidden" name="back" value="{{ path('app_home') }}">
                        <input type="hidden" name="_token"
                               value="{{ csrf_token('wf-refuse' ~ order.id) }}">
                        <button class="btn btn-sm btn-outline-danger rounded-1"
                                type="submit"
                                onclick="event.stopPropagation();">
                          Refuse
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </div>

  {# --- CLIENT VIEW --- #}
  {% elseif is_granted('ROLE_CLIENT') %}
    <div class="card bg-dark border-secondary rounded-2">
      <div class="card-header border-secondary d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Last thumbnails</span>
        <span class="badge text-bg-secondary rounded-1">
          {{ clientThumbnails|length }}
        </span>
      </div>

      <div class="card-body">
        {% if clientThumbnails is empty %}
          <div class="text-secondary small">
            No thumbnails delivered yet.
          </div>
        {% else %}
          <div class="row g-3">
            {% for thumb in clientThumbnails %}
              <div class="col-6 col-md-4">
                <div class="bg-dark border rounded-1 p-2 h-100 d-flex flex-column">
                  <a href="{{ asset('uploads/order-thumbnails/' ~ thumb.fileName) }}"
                     target="_blank"
                     class="mb-2">
                    <img src="{{ asset('uploads/order-thumbnails/' ~ thumb.fileName) | imagine_filter('thumb_320x180') }}"
                         alt="Thumbnail {{ loop.index }}"
                         class="img-fluid rounded-1"
                         loading="lazy"
                         style="aspect-ratio:16/9;object-fit:cover;">
                  </a>

                  <div class="small text-secondary mb-1">
                    Order:
                    <a href="{{ path('app_order_show', { id: thumb.order.id }) }}"
                       class="link-light text-decoration-underline">
                      {{ thumb.order.title }}
                    </a>
                  </div>

                  <div class="small text-secondary mb-2">
                    {{ (thumb.fileSize/1024)|number_format(0, ',', ' ') }} KB
                  </div>

                  <div class="mt-auto d-flex gap-2">
                    <a class="btn btn-sm btn-outline-light rounded-1"
                       href="{{ path('app_thumbnail_download', { id: thumb.id }) }}">
                      Download
                    </a>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  {% else %}
    <p class="text-secondary">
      Welcome to ThumbUp.
    </p>
  {% endif %}
</div>

<style>
@media (max-width: 576px) {
  .home-table thead {
    display: none;
  }

  .home-table tbody tr {
    display: block;
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }

  .home-table tbody tr:last-child {
    border-bottom: none;
  }

  .home-table tbody td {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    width: 100%;
    padding: 0.2rem 0;
    border: 0;
    font-size: 0.85rem;
  }

  .home-table tbody td::before {
    content: attr(data-label);
    font-weight: 500;
    color: rgba(255, 255, 255, 0.6);
    margin-right: 0.75rem;
    flex: 0 0 auto;
  }

  .home-table tbody td.fw-medium {
    font-size: 0.9rem;
  }

  .home-table tbody td .btn {
    padding: 0.15rem 0.45rem;
    font-size: 0.75rem;
  }
}
</style>
{% endblock %}
