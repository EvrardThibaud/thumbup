
{% extends 'base.html.twig' %}
{% block title %}Edit account{% endblock %}

{% block body %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 m-0">üë§ Edit account</h1>
    <a href="{{ path('app_account') }}" class="btn btn-sm btn-outline-light rounded-1">‚Üê Back</a>
  </div>
  {% for label, messages in app.flashes %}
    {% for message in messages %}
      <div class="alert alert-{{ label }} small py-2 mb-2">
        {{ message }}
      </div>
    {% endfor %}
  {% endfor %}

  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <div class="card bg-dark border-secondary rounded-2">
        <div class="card-header border-secondary">
          <span class="fw-semibold">Profile</span>
        </div>
        <div class="card-body">
          {% if user.client %}
            <form method="post"
                  action="{{ path('app_account_edit') }}"
                  class="vstack gap-3"
                  data-turbo="false">
              <input type="hidden" name="_action" value="profile">
              <input type="hidden" name="_token" value="{{ csrf_token('edit_profile') }}">

              <div>
                <label class="form-label small mb-1">Username</label>
                <input type="text"
                       name="username"
                       value="{{ user.client.name }}"
                       class="form-control form-control-sm bg-dark text-white border-secondary"
                       required>
                <div class="form-text text-secondary small">
                  This is the name used for your client profile.
                </div>
              </div>

                            {% set channels = user.client.youtubeChannels %}
              <div>
                <label class="form-label small mb-1">YouTube channels</label>

                <div class="vstack gap-2">
            
                  {% for ch in channels %}
                    <div class="row g-2 align-items-center">
                      <input type="hidden"
                             name="channels[{{ loop.index0 }}][id]"
                             value="{{ ch.id }}">

                      <div class="col-12 col-md-4">
                        <input type="text"
                               name="channels[{{ loop.index0 }}][name]"
                               value="{{ ch.name }}"
                               class="form-control form-control-sm bg-dark text-white border-secondary"
                               placeholder="Title (e.g. Main)">
                      </div>
                      <div class="col-12 col-md-8">
                        <input type="url"
                               name="channels[{{ loop.index0 }}][url]"
                               value="{{ ch.url }}"
                               class="form-control form-control-sm bg-dark text-white border-secondary"
                               placeholder="https://youtube.com/@yourchannel">
                      </div>
                    </div>
                  {% endfor %}

            
                  {% set extraIndex = channels|length %}
                  <div class="row g-2 align-items-center">
                    <div class="col-12 col-md-4">
                      <input type="text"
                             name="channels[{{ extraIndex }}][name]"
                             value=""
                             class="form-control form-control-sm bg-dark text-white border-secondary"
                             placeholder="Title (optional)">
                    </div>
                    <div class="col-12 col-md-8">
                      <input type="url"
                             name="channels[{{ extraIndex }}][url]"
                             value=""
                             class="form-control form-control-sm bg-dark text-white border-secondary"
                             placeholder="https://youtube.com/@newchannel">
                    </div>
                  </div>
                </div>

                <div class="form-text text-secondary small mt-1">
                  First channel is treated as main. Leave a row empty to remove it.
                </div>
              </div>


              <div class="d-flex gap-2 pt-2">
                <button class="btn btn-primary btn-sm rounded-1" type="submit">
                  Save profile
                </button>
              </div>
            </form>
          {% else %}
            <p class="text-secondary small mb-0">
              No client profile linked to this account.
            </p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card bg-dark border-secondary rounded-2">
        <div class="card-header border-secondary">
          <span class="fw-semibold">Security</span>
        </div>
        <div class="card-body">
          <p class="text-secondary small mb-2">Update your password.</p>

          {{ form_start(passwordForm, {
            attr: {
              class: 'vstack gap-3',
              'data-turbo': 'false'
            },
            action: path('app_account_edit')
          }) }}
            <input type="hidden" name="_action" value="password">
            <div>
              <label class="form-label small mb-1">Current password</label>
              <div class="input-group input-group-sm">
                {{ form_widget(passwordForm.currentPassword, {
                  attr: passwordForm.currentPassword.vars.attr|merge({
                    class: 'form-control',
                    autocomplete: 'current-password'
                  })
                }) }}
                <button type="button"
                        class="btn btn-outline-secondary border-start-0 js-toggle-password">
                  üëÅ
                </button>
              </div>
              <div class="form-text text-secondary small">
                Enter your existing password to confirm it‚Äôs really you.
              </div>

              {% if passwordForm.currentPassword.vars.errors|length %}
                <div class="alert alert-danger small py-1 px-2 mt-1 mb-0 rounded-1">
                  {{ form_errors(passwordForm.currentPassword) }}
                </div>
              {% endif %}
            </div>
            <div>
              <label class="form-label small mb-1">New password</label>
              <div class="input-group input-group-sm">
                {{ form_widget(passwordForm.newPassword, {
                  attr: passwordForm.newPassword.vars.attr|merge({
                    class: 'form-control',
                    autocomplete: 'new-password'
                  })
                }) }}
                <button type="button"
                        class="btn btn-outline-secondary border-start-0 js-toggle-password">
                  üëÅ
                </button>
              </div>
              <div class="form-text text-secondary small">
                At least 8 characters, including 1 uppercase letter, 1 lowercase letter,
                1 number and 1 special character. Don‚Äôt reuse your current password.
              </div>

              {% if passwordForm.newPassword.vars.errors|length %}
                <div class="alert alert-danger small py-1 px-2 mt-1 mb-0 rounded-1">
                  {{ form_errors(passwordForm.newPassword) }}
                </div>
              {% endif %}
            </div>
            <div>
              <label class="form-label small mb-1">Confirm new password</label>
              <div class="input-group input-group-sm">
                {{ form_widget(passwordForm.confirmNewPassword, {
                  attr: passwordForm.confirmNewPassword.vars.attr|merge({
                    class: 'form-control',
                    autocomplete: 'new-password'
                  })
                }) }}
                <button type="button"
                        class="btn btn-outline-secondary border-start-0 js-toggle-password">
                  üëÅ
                </button>
              </div>

              {% if passwordForm.confirmNewPassword.vars.errors|length %}
                <div class="alert alert-danger small py-1 px-2 mt-1 mb-0 rounded-1">
                  {{ form_errors(passwordForm.confirmNewPassword) }}
                </div>
              {% endif %}
            </div>

            <div class="d-flex gap-2 pt-2">
              <button class="btn btn-primary btn-sm rounded-1">
                Save new password
              </button>
            </div>

          {{ form_end(passwordForm) }}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  function initPasswordToggles() {
    document.querySelectorAll('.js-toggle-password').forEach(btn => {
      if (btn.dataset.bound === '1') {
        return;
      }
      btn.dataset.bound = '1';

      const group = btn.closest('.input-group');
      if (!group) return;
      const input = group.querySelector('input[type="password"], input[type="text"]');
      if (!input) return;

      btn.addEventListener('click', function (e) {
        e.preventDefault();
        const isPassword = input.type === 'password';
        input.type = isPassword ? 'text' : 'password';
        btn.textContent = isPassword ? 'üôà' : 'üëÅ';
      });
    });
  }

  document.addEventListener('DOMContentLoaded', initPasswordToggles);
  document.addEventListener('turbo:load', initPasswordToggles);
})();
</script>
{% endblock %}
