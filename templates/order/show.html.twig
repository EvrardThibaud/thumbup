{% extends 'base.html.twig' %}
{% block title %}Order #{{ order.id }}{% endblock %}

{% block body %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 m-0">üßæ Order <span class="text-secondary">#{{ order.id }}</span></h1>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-outline-light rounded-1" href="{{ back ?? path('app_order_index') }}">‚Üê Back</a>
      <a class="btn btn-sm btn-outline-light rounded-1" href="{{ path('app_order_edit', {'id': order.id, 'back': app.request.uri}) }}">‚úèÔ∏è Edit</a>
    </div>
  </div>

  {% set s = order.status.value %}
  {% set backUrl = back ?? app.request.uri %}
  {% set statusColorMap = {
    'created':  'secondary',
    'refused':  'danger',
    'canceled': 'dark',
    'accepted': 'warning',
    'doing':    'info',
    'delivered':'primary'
  } %}
  {% set statusLabelMap = {
    'created':  'Created',
    'refused':  'Refused',
    'canceled': 'Canceled',
    'accepted': is_granted('ROLE_ADMIN') ? 'To do' : 'Accepted',
    'doing':    'Doing',
    'delivered':'Delivered'
  } %}
  {% set badgeColor = statusColorMap[s] ?? 'secondary' %}
  {% set badgeLabel = statusLabelMap[s] ?? s %}

  {# Barre de statut + actions #}
  <div class="d-flex flex-wrap align-items-center gap-2 mb-3">

    {# TAG statut (plus fin) #}
    <span class="badge text-bg-{{ badgeColor }} rounded-1 px-2 py-1 small">{{ badgeLabel }}</span>

    {# TAG paid (unique, pas r√©p√©t√© plus bas) #}
    <span class="badge text-bg-{{ order.paid ? 'success' : 'warning' }} rounded-1 px-2 py-1 small">
      {{ order.paid ? 'Paid' : 'Unpaid' }}
    </span>

    {# S√©parateur visuel #}
    <span class="text-secondary mx-1">‚Ä¢</span>

    {# Actions ADMIN ‚Äî boutons bien ‚Äúboutons‚Äù #}
    {% if is_granted('ROLE_ADMIN') %}
      {% if s == 'created' %}
        <form method="post" action="{{ path('app_order_accept', {id: order.id, back: backUrl}) }}">
          <input type="hidden" name="_token" value="{{ csrf_token('wf-accept' ~ order.id) }}">
          <button class="btn btn-sm btn-primary rounded-1">Accept</button>
        </form>
        <form method="post" action="{{ path('app_order_refuse', {id: order.id, back: backUrl}) }}" onsubmit="return confirm('Refuse this order?');">
          <input type="hidden" name="_token" value="{{ csrf_token('wf-refuse' ~ order.id) }}">
          <button class="btn btn-sm btn-outline-danger rounded-1">Refuse</button>
        </form>
      {% elseif s == 'accepted' %}
        <form method="post" action="{{ path('app_order_start', {id: order.id, back: backUrl}) }}">
          <input type="hidden" name="_token" value="{{ csrf_token('wf-start' ~ order.id) }}">
          <button class="btn btn-sm btn-primary rounded-1">Start</button>
        </form>
      {% elseif s == 'doing' %}
        <form method="post" action="{{ path('app_order_deliver', {id: order.id, back: backUrl}) }}">
          <input type="hidden" name="_token" value="{{ csrf_token('wf-deliver' ~ order.id) }}">
          <button class="btn btn-sm btn-success rounded-1">Deliver</button>
        </form>
      {% endif %}

      {# Toggle Paid #}
      <form method="post" action="{{ path('app_order_toggle_paid', { id: order.id, back: backUrl }) }}">
        <input type="hidden" name="_token" value="{{ csrf_token('toggle-paid' ~ order.id) }}">
        <button class="btn btn-sm btn-outline-light rounded-1">
          {{ order.paid ? 'Unmark as paid' : 'Mark as paid' }}
        </button>
      </form>
    {% endif %}

    {# Action CLIENT ‚Äî Cancel uniquement si created #}
    {% if is_granted('ROLE_CLIENT') and not is_granted('ROLE_ADMIN') %}
      {% if s == 'created' %}
        <form method="post" action="{{ path('app_order_cancel', {id: order.id, back: backUrl}) }}" onsubmit="return confirm('Cancel this order?');">
          <input type="hidden" name="_token" value="{{ csrf_token('wf-cancel' ~ order.id) }}">
          <button class="btn btn-sm btn-outline-warning rounded-1">Cancel</button>
        </form>
      {% else %}
        <button class="btn btn-sm btn-outline-secondary rounded-1" disabled>Cancel</button>
        <span class="text-secondary small align-self-center">Cannot cancel at this stage.</span>
      {% endif %}
    {% endif %}
  </div>

  {% if is_granted('ROLE_CLIENT') and not is_granted('ROLE_ADMIN') %}
  {% set s = order.status.value %}
  {% set helpMap = {
    'created':  'We received your request. It‚Äôs waiting for review. You can still cancel it.',
    'accepted': 'Your order was accepted. It will be scheduled and started soon.',
    'doing':    'Work in progress. You‚Äôll get a preview when it‚Äôs ready.',
    'delivered':'A preview is available. Check it and tell us if you need changes.',
    'canceled': 'You canceled this order. It stays here for your records.',
    'refused':  'This order was refused. Feel free to contact us if you have questions.'
  } %}
  <div class="mt-2 p-2 rounded-1 small text-secondary border border-secondary-subtle">
    <span class="me-1">‚ÑπÔ∏è</span>{{ helpMap[s] ?? 'Status updated.' }}
    {% if s == 'created' %}
      <span class="ms-1 text-warning">You can cancel it until it‚Äôs accepted.</span>
    {% endif %}
  </div>
{% endif %}

  {# ‚Äî‚Äî‚Äî le reste de ta page (cards infos, time, etc.) reste identique ‚Äî‚Äî‚Äî #}


  {% set status = order.status.value %}
  {% set label = {'todo':'To do','doing':'Doing','delivered':'Delivered','paid':'Paid'}[status] ?? status %}
  {% set color = {'todo':'secondary','doing':'info','delivered':'primary','paid':'success'}[status] ?? 'secondary' %}

  <div class="card border-0 p-3 mb-3">
    <div class="row g-3">
      <div class="col-md-6">
        <div class="small text-secondary mb-1">Title</div>
        <div class="fw-medium">{{ order.title }}</div>
      </div>
      <div class="col-md-3">
        <div class="small text-secondary mb-1">Client</div>
        <div>{{ order.client ? order.client.name : '‚Äî' }}</div>
      </div>
      <div class="col-md-6">
        <div class="small text-secondary mb-1 ">Brief</div>
        <div class="text-secondary" style="white-space: pre-wrap">{{ order.brief }}</div>
      </div>
      <div class="col-md-2">
        <div class="small text-secondary mb-1">Price</div>
        <div>{{ (order.price / 100)|number_format(2, ',', ' ') }} ‚Ç¨</div>
      </div>
      <div class="col-md-2">
        <div class="small text-secondary mb-1">Due</div>
        <div>{{ order.dueAt ? order.dueAt|date('Y-m-d H:i') : '‚Äî' }}</div>
      </div>
      <div class="col-md-2">
        <div class="small text-secondary mb-1">Updated</div>
        <div>{{ order.updatedAt ? order.updatedAt|date('Y-m-d H:i') : '‚Äî' }}</div>
      </div>
    </div>
  </div>

  <div class="card border-0 p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0">‚è± Time logged</h2>
      <a class="btn btn-sm btn-primary rounded-1" href="{{ path('app_time_entry_new', {'orderId': order.id}) }}">+ Add time</a>
    </div>

    <p class="text-secondary mb-2">
      Total: <strong class="text-light">{{ order.getTotalMinutes() }} min</strong> ({{ order.getTotalHours() }} h)
    </p>

    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead class="small text-secondary">
          <tr>
            <th>Date</th>
            <th>Minutes</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
          {% for t in order.timeEntries %}
            <tr>
              <td>{{ t.createdAt ? t.createdAt|date('Y-m-d H:i') : '‚Äî' }}</td>
              <td>{{ t.minutes }}</td>
              <td class="text-secondary">{{ t.note }}</td>
            </tr>
          {% else %}
            <tr><td colspan="3" class="text-secondary">No time entries yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}
