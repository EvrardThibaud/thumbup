{% extends 'base.html.twig' %}
{% block title %}Order #{{ order.id }}{% endblock %}

{% block body %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 m-0">üßæ Order <span class="text-secondary">#{{ order.id }}</span></h1>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-outline-light rounded-1" href="{{ back ?? path('app_order_index') }}">‚Üê Back</a>
      {% if is_granted('ROLE_ADMIN') and not is_granted('ROLE_CLIENT') %}
        <a class="btn btn-sm btn-outline-light rounded-1"
          href="{{ path('app_order_edit', {
            id: order.id,
            back: path('app_order_show', { id: order.id })
          }) }}">
          ‚úèÔ∏è Edit
        </a>
      {% endif %}
    </div>
  </div>

{% include 'order/_status_stepper.html.twig' with { order: order } %}

{% set status = order.status.value %}
{% set label = {'todo':'To do','doing':'Doing','delivered':'Delivered','paid':'Paid'}[status] ?? status %}
{% set color = {'todo':'secondary','doing':'info','delivered':'primary','paid':'success'}[status] ?? 'secondary' %}
{% set hideTime = status in ['created','refused','canceled','accepted'] %}
{% set tz = app.user ? app.user.timezone : 'Europe/Paris' %}

<div class="mb-3">
  {% include 'order/_final_thumbnails.html.twig' with { order: order } %}
</div>

<div class="row g-3 mb-3">
  <div class="col-12 col-lg-6">
    <div class="card bg-dark border-secondary rounded-2 h-100">
      <div class="card-header border-secondary">
        <span class="fw-semibold">Order</span>
      </div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-sm-4 text-secondary">Title</dt>
          <dd class="col-sm-8 fw-medium">
            {{ order.title }}
          </dd>

          <dt class="col-sm-4 text-secondary">Client</dt>
          <dd class="col-sm-8">
            {{ order.client ? order.client.name : '‚Äî' }}
          </dd>

          <dt class="col-sm-4 text-secondary">Brief</dt>
          <dd class="col-sm-8">
            <div class="text-secondary" style="white-space: pre-wrap">
              {{ order.brief }}
            </div>
          </dd>

          <dt class="col-sm-4 text-secondary">Price</dt>
          <dd class="col-sm-8">
            {{ (order.price / 100)|number_format(2, ',', ' ') }} ‚Ç¨
          </dd>

          <dt class="col-sm-4 text-secondary">Due</dt>
          <dd class="col-sm-8">
            {{ order.dueAt ? order.dueAt|date('Y-m-d H:i', tz) : '‚Äî' }}
          </dd>
        </dl>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    {% include 'order/_client_files.html.twig' with { order: order } %}
  </div>
</div>

{% if not hideTime %}
  <div class="row g-3">
    {% if is_granted('ROLE_ADMIN') %}
      <div class="col-12 col-lg-6">
        <div class="card bg-dark border-secondary rounded-2 h-100" id="time-tracker">
          <div class="card-header border-secondary d-flex justify-content-between align-items-center">
            <div class="d-flex flex-column">
              <span class="fw-semibold">‚è± Time tracker</span>
              <span class="small text-secondary">Creates a TimeEntry for this order</span>
            </div>
          </div>

          <div class="card-body">
            <div id="timer-display"
                 class="fs-1 fw-monospace text-center py-2 bg-black bg-opacity-25 rounded-2 border border-secondary-subtle">
              00:00:00
            </div>

            <div class="mt-3 d-flex gap-2 justify-content-center">
              <button type="button"
                      class="btn btn-sm btn-success rounded-pill px-3 flex-fill"
                      id="timer-start">
                ‚ñ∂ Start
              </button>
              <button type="button"
                      class="btn btn-sm btn-warning rounded-pill px-3 flex-fill"
                      id="timer-pause"
                      disabled>
                ‚è∏ Pause
              </button>
              <button type="button"
                      class="btn btn-sm btn-outline-light rounded-pill px-3 flex-fill"
                      id="timer-reset"
                      disabled>
                ‚ü≤ Reset
              </button>
            </div>

            <form id="timer-form"
                  class="mt-3"
                  method="post"
                  action="{{ path('app_timeentry_from_timer', { id: order.id }) }}">
              <input type="hidden" name="elapsedSeconds" id="timer-elapsedSeconds" value="0">

              <div class="mb-2">
                <label for="timer-note" class="form-label small text-secondary mb-1">Note (optional)</label>
                <input type="text"
                       name="note"
                       id="timer-note"
                       class="form-control form-control-sm"
                       placeholder="What did you work on?">
              </div>

              <input type="hidden" name="_token" value="{{ csrf_token('timeentry_timer_' ~ order.id) }}">

              <button type="submit"
                      class="btn btn-sm btn-primary rounded-1 w-100"
                      id="timer-save"
                      disabled>
                Save time entry
              </button>
              <div class="form-text small text-secondary mt-1">
                Timer must run at least 1 minute before you can save.
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endif %}

    {% if is_granted('ROLE_ADMIN') or order.timeEntries|length > 0 %}
      <div class="col-12 col-lg-6">
        <div class="card bg-dark border-secondary rounded-2 h-100">
          <div class="card-header border-secondary d-flex justify-content-between align-items-center">
            <div class="d-flex flex-column">
              <span class="fw-semibold">‚è± Time logged</span>
              <span class="small text-secondary">
                Total: 
                <strong class="text-light">
                {% set totalMinutes = order.getTotalMinutes() %}
                {% set hours = (totalMinutes / 60)|round(0, 'floor') %}
                {% set minutes = totalMinutes % 60 %}
                {% if hours > 0 %}{{ hours }}h{% endif %}
                {% if minutes > 0 %}{{ minutes }}min{% endif %}
                </strong>
                -
                {{ order.getTotalMinutes() }} min
              </span>
            </div>
            {% if is_granted('ROLE_ADMIN') %}
              <a class="btn btn-sm btn-primary rounded-1"
                 href="{{ path('app_time_entry_new', {'orderId': order.id}) }}">+ Add time</a>
            {% endif %}
          </div>

          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead class="small text-secondary">
                  <tr>
                    <th>Date</th>
                    <th>Minutes</th>
                    <th>Note</th>
                  </tr>
                </thead>
                <tbody>
                  {% for t in order.timeEntries %}
                    <tr>
                      <td>{{ t.createdAt ? t.createdAt|date('Y-m-d H:i') : '‚Äî' }}</td>
                      <td>{{ t.minutes }}</td>
                      <td class="text-secondary">{{ t.note }}</td>
                    </tr>
                  {% else %}
                    <tr>
                      <td colspan="3" class="text-secondary">No time entries yet.</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  <script>
    (function () {
      const display = document.getElementById('timer-display');
      if (!display) {
        return;
      }

      const startBtn = document.getElementById('timer-start');
      const pauseBtn = document.getElementById('timer-pause');
      const resetBtn = document.getElementById('timer-reset');
      const saveBtn = document.getElementById('timer-save');
      const elapsedInput = document.getElementById('timer-elapsedSeconds');

      let startTimestamp = null;
      let elapsed = 0; // seconds
      let intervalId = null;

      function formatTime(seconds) {
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;

        const pad = (v) => String(v).padStart(2, '0');
        return pad(hrs) + ':' + pad(mins) + ':' + pad(secs);
      }

      function render() {
        display.textContent = formatTime(elapsed);
        elapsedInput.value = elapsed;
        saveBtn.disabled = elapsed < 60;
      }

      function tick() {
        const now = Date.now();
        elapsed = Math.floor((now - startTimestamp) / 1000);
        render();
      }

      startBtn.addEventListener('click', function () {
        if (intervalId) {
          return;
        }
        const now = Date.now();
        startTimestamp = now - elapsed * 1000;
        intervalId = window.setInterval(tick, 1000);

        startBtn.disabled = true;
        pauseBtn.disabled = false;
        resetBtn.disabled = false;
      });

      pauseBtn.addEventListener('click', function () {
        if (!intervalId) {
          return;
        }
        window.clearInterval(intervalId);
        intervalId = null;

        const now = Date.now();
        elapsed = Math.floor((now - startTimestamp) / 1000);
        render();

        startBtn.disabled = false;
        pauseBtn.disabled = true;
      });

      resetBtn.addEventListener('click', function () {
        if (intervalId) {
          window.clearInterval(intervalId);
          intervalId = null;
        }

        elapsed = 0;
        startTimestamp = null;
        render();

        startBtn.disabled = false;
        pauseBtn.disabled = true;
        resetBtn.disabled = true;
      });

      render();
    })();
  </script>
{% endif %}
{% endblock %}
