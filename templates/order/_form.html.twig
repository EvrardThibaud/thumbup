{# templates/order/_form.html.twig ‚Äî base with live preview + delete for attachments #}
{{ form_start(form) }}

<div class="vstack gap-3">
  <div>
    <label class="form-label mb-1">üìù Title</label>
    {{ form_widget(form.title, { attr: form.title.vars.attr|merge({'class':'form-control','placeholder':'E.g. Face close-up, bold text ‚ÄúNEW VIDEO‚Äù'}) }) }}
    {{ form_errors(form.title) }}
  </div>

  <div>
    <label class="form-label mb-1">üìÑ Brief</label>
    {{ form_widget(form.brief, { attr: form.brief.vars.attr|merge({'class':'form-control','rows':8,'placeholder':'Tell us what you need: style, mood, colors, assets‚Ä¶'}) }) }}
    {{ form_errors(form.brief) }}
  </div>

  <div>
    <label class="form-label mb-1">‚è∞ Due at</label>
      {{ form_widget(form.dueAt, {
          attr: form.dueAt.vars.attr|merge({
              'class':'form-control',
              'min': min_due_at|default(null)
          })
      }) }}
      {{ form_errors(form.dueAt) }}
  </div>

  {# ---- Price (pretty) + presets ---- #}
  <div>
    <label class="form-label mb-1">üí∂ Price</label>
    <div class="input-group">
      <input type="text" class="form-control js-price-euros"
             name="pretty_price"
             value=""
             placeholder="e.g., 15,00" autocomplete="off">
      <span class="input-group-text">‚Ç¨</span>
    </div>
    {{ form_widget(form.price) }} {# hidden cents field #}
    {{ form_errors(form.price) }}

    <div class="d-flex flex-wrap gap-2 mt-2">
      {% set presets = [500,1000,1500,2000,2500,3000] %}
      {% for c in presets %}
        <button type="button" class="btn btn-sm btn-outline-secondary rounded-1 js-preset" data-cents="{{ c }}">
          {{ (c/100)|number_format(2, ',', ' ') }} ‚Ç¨
        </button>
      {% endfor %}
      {% if lastPriceCents is defined and lastPriceCents %}
        <button type="button" class="btn btn-sm btn-outline-primary rounded-1 js-preset" data-cents="{{ lastPriceCents }}">
          Last: {{ (lastPriceCents/100)|number_format(2, ',', ' ') }} ‚Ç¨
        </button>
      {% endif %}
    </div>
    <div class="form-text text-secondary">Minimum 5,00 ‚Ç¨.</div>
  </div>

  {# ---- Attachments with LIVE PREVIEW + DELETE (client-side) ---- #}
  {% set inputId = form.attachments.vars.id %}
  <div>
    <label class="form-label mb-1">üìé Attach files (PDF or images)</label>
    {{ form_widget(form.attachments, {
      attr: form.attachments.vars.attr|merge({
        'class':'form-control',
        'id': inputId,
        'accept':'image/png,image/jpeg,image/webp,application/pdf',
        'multiple':'multiple'
      })
    }) }}
    {{ form_errors(form.attachments) }}
    <div id="{{ inputId }}__preview" class="row g-2 mt-2"></div>
    <div class="form-text text-secondary">PNG/JPG/WebP/PDF, up to 25 MB each.</div>
  </div>

  {% if form.children['client'] is defined %}
    <div>
      <label class="form-label mb-1">üë§ Client</label>
      {{ form_widget(form.client, { attr: form.client.vars.attr|merge({'class':'form-select'}) }) }}
      {{ form_errors(form.client) }}
    </div>
  {% endif %}

  {% if form.children['status'] is defined %}
    <div>
      <label class="form-label mb-1">üè∑Ô∏è Status</label>
      {{ form_widget(form.status, { attr: form.status.vars.attr|merge({'class':'form-select'}) }) }}
      {{ form_errors(form.status) }}
    </div>
  {% endif %}

  {% if form.children['paid'] is defined %}
    <div class="form-check">
      {{ form_widget(form.paid, { attr: {'class':'form-check-input','id':'paid-check'} }) }}
      <label for="paid-check" class="form-check-label">Paid</label>
      {{ form_errors(form.paid) }}
    </div>
  {% endif %}

  <div class="d-flex gap-2 pt-2">
    <button class="btn btn-primary rounded-1">{{ button_label|default('Save') }}</button>
    {% if back_path is defined and back_path %}
      <a class="btn btn-outline-light rounded-1" href="{{ back_path }}">Cancel</a>
    {% endif %}
  </div>
</div>

{{ form_end(form) }}

<style>
  .form-label{ display:block; }
  #{{ inputId }}__preview .thumb{
    position:relative;border:1px solid rgba(255,255,255,.15);
    border-radius:.5rem;padding:.5rem;background:rgba(255,255,255,.03);
  }
  #{{ inputId }}__preview img,
  #{{ inputId }}__preview .pdf-icon{
    width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:.35rem;
    background:rgba(255,255,255,.05);
  }
  #{{ inputId }}__preview .btn-remove{
    position:absolute;top:.25rem;right:.25rem;line-height:1;padding:.15rem .4rem;
  }
</style>

<script>
// Price formatting + presets -> sync hidden cents
(function(){
  const centsInput = document.querySelector('input[name$="[price]"]'); // HiddenType
  const prettyInput = document.querySelector('.js-price-euros');
  const presets = document.querySelectorAll('.js-preset');

  function fmt(c){ return (c/100).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function parseToCents(str){
    if(!str) return NaN;
    const n = String(str).replace(/[‚Ç¨\s]/g,'').replace(',','.');
    const f = parseFloat(n);
    if(isNaN(f)) return NaN;
    return Math.round(f*100);
  }
  function syncFromPretty(){
    const c = parseToCents(prettyInput.value);
    if(!isNaN(c)){ const v = Math.max(500,c); centsInput.value = String(v); prettyInput.value = fmt(v); }
  }
  function setCents(c){
    const v = Math.max(500, c|0);
    centsInput.value = String(v);
    prettyInput.value = fmt(v);
  }

  prettyInput?.addEventListener('change', syncFromPretty);
  prettyInput?.addEventListener('blur', syncFromPretty);
  presets.forEach(b => b.addEventListener('click', () => setCents(parseInt(b.dataset.cents||'0',10))));

  if(!centsInput.value){ setCents(500); }
})();
</script>

<script>
// Attachments preview + client-side delete using DataTransfer
(function initAttachments(){
  const input   = document.getElementById('{{ inputId }}');
  const preview = document.getElementById('{{ inputId }}__preview');
  if (!input || !preview) return;

  // Keep an editable FileList via DataTransfer
  let dt = window.DataTransfer ? new DataTransfer() : null;

  function rebuildFrom(dtLike){
    preview.innerHTML = '';
    const files = dtLike ? dtLike.files : input.files;
    Array.from(files).forEach((file, idx) => {
      const col  = document.createElement('div'); col.className='col-6 col-md-3';
      const card = document.createElement('div'); card.className='thumb';

      const close = document.createElement('button');
      close.type='button';
      close.className='btn btn-sm btn-outline-danger rounded-1 btn-remove';
      close.textContent='√ó';

      close.addEventListener('click', () => {
        if (dt) {
          const tmp = new DataTransfer();
          Array.from(dt.files).forEach((f,i)=>{ if(i!==idx) tmp.items.add(f); });
          dt = tmp;
          input.files = dt.files;
        } else {
          // Fallback: recreate from current FileList (limited support if no DataTransfer)
          const arr = Array.from(input.files).filter((_,i)=>i!==idx);
          const tmp = new DataTransfer();
          arr.forEach(f=>tmp.items.add(f));
          input.files = tmp.files;
        }
        rebuildFrom(dt);
      });

      let media;
      if (file.type && file.type.startsWith('image/')) {
        media = document.createElement('img');
        media.alt = file.name;
        const r = new FileReader();
        r.onload = e => media.src = e.target.result;
        r.readAsDataURL(file);
      } else {
        media = document.createElement('div');
        media.className='pdf-icon d-flex align-items-center justify-content-center';
        media.innerHTML = '<span class="badge text-bg-light text-dark">PDF</span>';
      }

      const cap = document.createElement('div');
      cap.className='small text-truncate mt-2 text-secondary';
      cap.textContent = file.name;

      card.appendChild(close);
      card.appendChild(media);
      card.appendChild(cap);
      col.appendChild(card);
      preview.appendChild(col);
    });
  }

  input.addEventListener('change', () => {
    if (dt) {
      // accumulate selections
      Array.from(input.files).forEach(f => dt.items.add(f));
      input.files = dt.files;
    }
    rebuildFrom(dt);
  });

  // If Turbo is used, ensure preview survives navigation
  document.addEventListener('turbo:load', () => rebuildFrom(dt));
})();
</script>
