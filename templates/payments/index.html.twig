{% extends 'base.html.twig' %}
{% block title %}Payments{% endblock %}

{% block body %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 m-0">ðŸ’³ Payments</h1>
    {% if is_admin %}
      <div class="small text-secondary">All payments (admin).</div>
    {% else %}
      <div class="small text-secondary">Select orders to pay.</div>
    {% endif %}
  </div>

  {% set tz = app.user ? app.user.timezone : 'Europe/Paris' %}

  {# ================= ADMIN VIEW ================= #}
  {% if is_admin %}
    <div class="card bg-dark border-0">
      <div class="table-responsive">
        <table class="table table-dark table-hover align-middle mb-0">
          <colgroup>
            <col style="width: 120px;">  {# user id #}
            <col>                        {# client #}
            <col style="width: 140px;">  {# method #}
            <col style="width: 180px;">  {# date #}
            <col style="width: 160px;">  {# amount #}
          </colgroup>
          <thead class="small text-secondary">
            <tr>
              <th>User ID</th>
              <th>Client</th>
              <th>Method</th>
              <th>Date</th>
              <th class="text-end">Amount</th>
            </tr>
          </thead>
          <tbody>
          {% for p in payments %}
            <tr>
              <td class="text-secondary">{{ p.user ? p.user.id : 'â€”' }}</td>
              <td>{{ p.client ? p.client.name : 'â€”' }}</td>
              <td><span class="badge text-bg-primary rounded-1">{{ p.paymentMethod|upper }}</span></td>
              <td class="text-secondary">{{ p.createdAt|date('Y-m-d H:i', tz) }}</td>
              <td class="text-end font-monospace">â‚¬ {{ (p.amountCents/100)|number_format(2, ',', ' ') }}</td>
            </tr>
          {% else %}
            <tr><td colspan="5" class="text-secondary">No payments yet.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  {# ================= CLIENT VIEW ================= #}
  {% else %}
    <form method="post" action="{{ path('app_payments_checkout_start') }}" id="pay-form" class="card bg-dark border-0 mb-3">
      <input type="hidden" name="_token" value="{{ csrf_token('checkout-start') }}">
      <div class="card-body d-flex flex-wrap align-items-center gap-3">
        <div class="form-check m-0">
          <input class="form-check-input" type="checkbox" id="check-all">
          <label class="form-check-label" for="check-all">Select all</label>
        </div>

        <div class="ms-auto d-flex align-items-center gap-2">
          <span class="text-secondary small">Total selected</span>
          <span id="total-euros" class="badge text-bg-light text-dark font-monospace" style="min-width: 120px;">â‚¬ 0,00</span>
          <button type="submit" class="btn btn-success rounded-1" id="pay-btn" disabled>Next</button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-dark table-hover align-middle mb-0" id="payments-table">
          <colgroup>
            <col style="width: 2.75rem;">
            <col>
            <col style="width: 140px;">
            <col style="width: 140px;">
            <col style="width: 170px;">
          </colgroup>
          <thead class="small text-secondary">
            <tr>
              <th></th>
              <th>Title</th>
              <th>Status</th>
              <th class="text-end">Price</th>
              <th class="text-secondary">Date</th>
            </tr>
          </thead>
          <tbody>
          {% set currentMonthKey = '' %}
          {% for o in orders %}
            {% set d = (o.updatedAt ?? o.createdAt) %}
            {% set monthKey = d|date('Y-m') %}
            {% set monthLabel = d|date('F Y') %}
            {% if monthKey != currentMonthKey %}
              {% set currentMonthKey = monthKey %}
              <tr class="table-active">
                <td>
                  <input class="form-check-input js-month" type="checkbox" id="m-{{ monthKey }}" data-month="{{ monthKey }}">
                </td>
                <td colspan="4" class="fw-semibold">
                  <label for="m-{{ monthKey }}" class="mb-0">Select all in {{ monthLabel }}</label>
                </td>
              </tr>
            {% endif %}

            <tr class="row-click" data-href="{{ path('app_order_show', {id: o.id}) }}" data-month="{{ monthKey }}">
              <td>
                <input class="form-check-input js-order"
                       type="checkbox"
                       name="orders[]"
                       value="{{ o.id }}"
                       data-cents="{{ o.price|default(0) }}"
                       data-month="{{ monthKey }}"
                       onclick="event.stopPropagation();">
              </td>
              <td class="fw-medium">
                <a class="text-reset text-decoration-none" href="{{ path('app_order_show', {id: o.id}) }}"
                   onclick="event.stopPropagation();">{{ o.title }}</a>
              </td>
              <td>
                {% set s = o.status.value %}
                {% set statusLabelMap = {
                  'created':'Created','refused':'Refused','canceled':'Canceled',
                  'accepted': is_granted('ROLE_ADMIN') ? 'To do' : 'Accepted',
                  'doing':'Doing','delivered':'Delivered','revision':'Revision','finished':'Finished'
                } %}
                {% set statusColorMap = {
                  'created':'secondary','refused':'danger','canceled':'dark',
                  'accepted':'warning','doing':'info','delivered':'primary','revision':'warning','finished':'success'
                } %}
                <span class="badge text-bg-{{ statusColorMap[s] ?? 'secondary' }} rounded-1">{{ statusLabelMap[s] ?? s }}</span>
              </td>
              <td class="text-end font-monospace price-cell">â‚¬ {{ (o.price/100)|number_format(2, ',', ' ') }}</td>
              <td class="text-secondary">{{ d|date('Y-m-d H:i') }}</td>
            </tr>
          {% else %}
            <tr><td colspan="5" class="text-secondary">No unpaid delivered orders.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </form>

    <style>
    #payments-table td.price-cell { white-space: nowrap; }
    #payments-table td, #payments-table th { vertical-align: middle; }
    .row-click { cursor: pointer; }
    </style>

    <script>
    (function(){
      const euros = (cents) => 'â‚¬ ' + (cents/100).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
      const totalEl   = document.getElementById('total-euros');
      const payBtn    = document.getElementById('pay-btn');
      const masterAll = document.getElementById('check-all');
      const orderChecks = () => Array.from(document.querySelectorAll('.js-order'));
      const monthMasters = () => Array.from(document.querySelectorAll('.js-month'));

      function recalc(){
        let cents = 0, any = false;
        for (const c of orderChecks()) if (c.checked) { cents += parseInt(c.dataset.cents||'0',10); any = true; }
        totalEl.textContent = euros(cents);
        payBtn.disabled = !any;
      }
      function setAll(state){
        orderChecks().forEach(c => c.checked = state);
        monthMasters().forEach(m => m.checked = state);
        recalc(); syncMasters();
      }
      function setMonth(monthKey, state){
        orderChecks().filter(c => c.dataset.month===monthKey).forEach(c => c.checked = state);
        recalc(); syncMasters();
      }
      function syncMasters(){
        const checks = orderChecks();
        const allChecked = checks.length>0 && checks.every(c=>c.checked);
        const noneChecked = checks.every(c=>!c.checked);
        masterAll.indeterminate = !allChecked && !noneChecked && checks.some(c=>c.checked);
        masterAll.checked = allChecked;
        monthMasters().forEach(m=>{
          const k=m.dataset.month, arr=checks.filter(c=>c.dataset.month===k);
          const a=arr.length>0 && arr.every(c=>c.checked), n=arr.every(c=>!c.checked);
          m.indeterminate = !a && !n && arr.some(c=>c.checked);
          m.checked=a;
        });
      }
      masterAll?.addEventListener('change', ()=>setAll(masterAll.checked));
      monthMasters().forEach(m=>m.addEventListener('change',()=>setMonth(m.dataset.month,m.checked)));
      orderChecks().forEach(c=>c.addEventListener('change',()=>{recalc();syncMasters();}));
      document.querySelectorAll('tr.row-click').forEach(tr=>{
        tr.addEventListener('click', (e)=>{
          if (e.target.closest('input,button,label,a')) return;
          const href = tr.dataset.href; if (href) window.location.href = href;
        });
      });
      recalc(); syncMasters();
    })();
    </script>
  {% endif %}
</div>
{% endblock %}
